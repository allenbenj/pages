<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connections Diagram - State v. Benjamin Allen</title>
    <link rel="stylesheet" href="shared/styles.css?v=639006186749527756">

</head>
<body>
    <div class="container">
        <div class="header">
             <h1>An Edifice of Lies</h1>
            <h2>“Connections reveal the architecture of the setup.”</h2>
        </div>

        <link rel="stylesheet" href="shared/carousel-nav.css">
        
        <div class="carousel-nav-wrapper">
            <div class="orbital-ring ring-1"></div>
            <div class="orbital-ring ring-2"></div>
            <div class="orbital-ring ring-3"></div>
            
            <img src="documents/graphics/logo_for_the_abused.png" alt="Logo" class="carousel-center">
            
            <div class="carousel-orbital-track" id="orbitalTrack">
                <div class="orbital-item" data-href="index.html"><a href="index.html" class="orbital-nav-link">Overview</a></div>
                <div class="orbital-item" data-href="players.html"><a href="players.html" class="orbital-nav-link">Key Players</a></div>
                <div class="orbital-item" data-href="connections.html"><a href="connections.html" class="orbital-nav-link">Connections</a></div>
                <div class="orbital-item" data-href="timeline.html"><a href="timeline.html" class="orbital-nav-link">Timeline</a></div>
                <div class="orbital-item" data-href="evidence.html"><a href="evidence.html" class="orbital-nav-link">Evidence</a></div>
                <div class="orbital-item" data-href="misconduct.html"><a href="misconduct.html" class="orbital-nav-link">Misconduct</a></div>
                <div class="orbital-item" data-href="contradictions.html"><a href="contradictions.html" class="orbital-nav-link">Contradictions</a></div>
                <div class="orbital-item" data-href="scene.html"><a href="scene.html" class="orbital-nav-link">Scene</a></div>
                <div class="orbital-item" data-href="contradictions_grouped.html"><a href="contradictions_grouped.html" class="orbital-nav-link">List of Lies</a></div>
                <div class="orbital-item" data-href="misconductandfailure.html"><a href="misconductandfailure.html" class="orbital-nav-link">Mindmaps</a></div>
                <div class="orbital-item" data-href="documentspage.html"><a href="documentspage.html" class="orbital-nav-link">Documents</a></div>
                <div class="orbital-item" data-href="solutions.html"><a href="solutions.html" class="orbital-nav-link">Solutions</a></div>
            </div>
            
            <div class="carousel-indicators" id="indicators"></div>
            <div class="hover-zone hover-left" id="hoverLeft"><span class="hover-arrow">‹</span></div>
            <div class="hover-zone hover-right" id="hoverRight"><span class="hover-arrow">›</span></div>
        </div>
        
        <script src="shared/orbital-carousel.js"></script>

        <!-- Draw.io Connections viewer -->
        <section id="connections" style="margin-top: 30px; padding: 0 20px;">
            <h2 class="section-title">Connections Diagram</h2>
            <p style="text-align: center; color: #94a3b8; margin-bottom: 20px;">
                Interactive view of the connections diagram. Click names to focus on nodes in the embedded viewer.
            </p>
            <div class="connections-wrapper">
                <div class="connections-sidebar" id="connections-sidebar">
                    <div class="connections-sidebar-header">
                        <strong>Nodes</strong>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <a class="button" id="open-editor" href="shared/Connections_20250719_233212.drawio.xml" title="Download/Open XML">Download XML</a>
                            <button id="open-defaults" title="Open defaults">Open Defaults</button>
                        </div>
                    </div>
                    <div class="connections-controls-help" aria-hidden="false">
                        <details class="connections-help" role="group" aria-label="Diagram controls" open>
                            <summary>Controls</summary>
                            <ul>
                                <li><strong>Pan</strong>: Middle mouse drag or Space + drag.</li>
                                <li><strong>Zoom</strong>: Mouse wheel (Ctrl/⌘ for precision).</li>
                                <li><strong>Select</strong>: Click a name to focus and zoom.</li>
                                <li><strong>Fit</strong>: Use the viewer toolbar or the Fit button.</li>
                            </ul>
                        </details>
                    </div>
                    <div class="connections-list" id="connections-list">
                        <p style="color:#94a3b8;padding:10px;">Loading list...</p>
                    </div>
                </div>
                <div class="connections-viewport" id="connections-viewport">
                    <iframe
                        id="drawio-iframe"
                        title="Connections diagram"
                        tabindex="-1"
                        style="width:100%;height:100%;border:0;"
                        src="https://embed.diagrams.net/?embed=1&proto=json&spin=1&saveAndExit=0&noSaveBtn=1&ui=min"></iframe>
                </div>
            </div>
        </section>
    </div>

    <script src="shared/card-mapper.js"></script>
    <script src="shared/card-colors.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            async function setupDrawioConnections() {
                const xmlUrl = 'shared/Connections_20250719_233212.drawio.xml';
                const listEl = document.getElementById('connections-list');
                const iframe = document.getElementById('drawio-iframe');

                try {
                    const res = await fetch(encodeURI(xmlUrl));
                    if (!res.ok) throw new Error('Could not fetch drawio XML: ' + res.status);
                    const xmlText = await res.text();

                    // Parse nodes
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(xmlText, 'text/xml');
                    const cells = Array.from(doc.querySelectorAll('mxCell[vertex="1"]'));

                    // Build list
                    listEl.innerHTML = '';
                    const nodes = cells.map(cell => {
                        const id = cell.getAttribute('id');
                        let raw = cell.getAttribute('value') || '';
                        const tmp = document.createElement('div');
                        tmp.innerHTML = raw;
                        const label = tmp.textContent.trim() || id;
                        return { id, label, cell };
                    });

                    nodes.forEach(n => {
                        const li = document.createElement('div');
                        li.className = 'node-item';
                        li.textContent = n.label;
                        li.dataset.cellId = n.id;
                        li.addEventListener('click', () => {
                            try {
                                iframe.contentWindow.postMessage(JSON.stringify({ action: 'select', ids: [n.id] }), '*');
                                iframe.contentWindow.postMessage(JSON.stringify({ action: 'zoom', value: 1.2 }), '*');
                            } catch (e) {
                                console.warn('postMessage to draw.io failed', e);
                            }
                            const prev = listEl.querySelector('.node-item.selected');
                            if (prev) prev.classList.remove('selected');
                            li.classList.add('selected');
                        });
                        listEl.appendChild(li);
                    });

                    const sendLoad = () => {
                        const sx = window.scrollX, sy = window.scrollY;
                        try {
                            iframe.contentWindow.postMessage(JSON.stringify({ action: 'load', xml: xmlText, autosave: 0 }), '*');
                            if (sy < 100) window.scrollTo(sx, sy);
                            
                            setTimeout(() => {
                                try {
                                    const fsx = window.scrollX, fsy = window.scrollY;
                                    iframe.contentWindow.postMessage(JSON.stringify({ action: 'fit' }), '*');
                                    if (fsy < 100) window.scrollTo(fsx, fsy);
                                } catch (e) {}
                            }, 800);
                        } catch (e) {}
                    };

                    window.addEventListener('message', (evt) => {
                        let data = evt.data;
                        try { data = JSON.parse(typeof data === 'string' ? data : JSON.stringify(data)); } catch(e) { data = evt.data; }
                        if (data && data.event === 'configure') {
                            sendLoad();
                        }
                    });

                    setTimeout(sendLoad, 600);

                    const defaultKeywords = ['giglio', 'brady', 'fabricat', 'extortion', 'conceal', 'perjury', 'false', 'withhold'];
                    document.getElementById('open-defaults').addEventListener('click', () => {
                        const matches = nodes.filter(n => defaultKeywords.some(k => n.label.toLowerCase().includes(k)));
                        matches.slice(0, 30).forEach(m => {
                            try { iframe.contentWindow.postMessage(JSON.stringify({ action: 'select', ids: [m.id] }), '*'); } catch(e) {}
                        });
                    });

                } catch (err) {
                    console.error('Failed to initialize connections viewer', err);
                    listEl.innerHTML = `<p style="color:#ef4444;padding:12px;">Failed to load connections: ${err.message}</p>`;
                }
            }

            setupDrawioConnections();
        });
    </script>

    <!-- Image Modal -->
    <div id="imageModal" onclick="closeImageModal()">
        <span class="modal-close" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" src="" alt="Full resolution image">        <video id="modalVideo" controls></video>
    </div>

    <script src="shared/image-modal.js"></script>
</body>
</html>
